## Phase 3: Infrastructure Deployment Guide

**Status**: Ready for deployment
**Estimated Time**: 1-2 hours
**Prerequisites**: GitHub account, Railway/Supabase account

---

## Option 1: Deploy to Railway (Recommended)

Railway provides free tier with PostgreSQL included.

### Step 1: Set Up Railway Project

1. **Create Railway account**: https://railway.app
2. **Create new project**:
   - Click "New Project"
   - Select "Deploy from GitHub repo"
   - Connect this repository

3. **Add PostgreSQL database**:
   - In your project, click "+ New"
   - Select "Database" → "PostgreSQL"
   - Railway auto-creates `DATABASE_URL` environment variable

### Step 2: Configure Environment Variables

In Railway dashboard → Variables, add:

```bash
# Auto-provided by Railway
DATABASE_URL=<auto-generated>

# Add these manually
CORS_ORIGINS=https://yourdomain.com,http://localhost:3000
SQL_ECHO=false
```

### Step 3: Deploy Application

```bash
# Railway CLI (optional - or use GitHub auto-deploy)
npm install -g @railway/cli
railway login
railway link
railway up
```

**Or**: Push to GitHub and Railway auto-deploys.

### Step 4: Run Database Migrations

```bash
# Option A: Use Railway CLI
railway run python scripts/migrate_to_db.py

# Option B: SSH into container
railway shell
python scripts/migrate_to_db.py
```

### Step 5: Verify Deployment

```bash
# Health check
curl https://your-app.up.railway.app/health

# Graph stats
curl https://your-app.up.railway.app/graph/stats
```

---

## Option 2: Deploy to Supabase + Vercel

Supabase for database, Vercel for API.

### Step 1: Set Up Supabase Database

1. Create Supabase project: https://supabase.com
2. Get connection string:
   - Settings → Database → Connection string (Direct connection)
   - Copy the `postgresql://` URL

### Step 2: Run Migrations Locally

```bash
# Set database URL
export DATABASE_URL="postgresql://postgres:[password]@[host]:5432/postgres"

# Install dependencies
pip install -r requirements.txt

# Run migration
python scripts/migrate_to_db.py
```

### Step 3: Deploy API to Vercel

```bash
# Install Vercel CLI
npm install -g vercel

# Deploy
vercel

# Set environment variables
vercel env add DATABASE_URL
```

Create `vercel.json`:
```json
{
  "builds": [{
    "src": "src/api/main.py",
    "use": "@vercel/python"
  }],
  "routes": [{
    "src": "/(.*)",
    "dest": "src/api/main.py"
  }]
}
```

---

## Local Development Setup

### Step 1: Install PostgreSQL

**macOS (Homebrew)**:
```bash
brew install postgresql@14
brew services start postgresql@14
createdb consequence_ai
```

**Ubuntu/Debian**:
```bash
sudo apt-get install postgresql-14
sudo systemctl start postgresql
sudo -u postgres createdb consequence_ai
```

**Windows**:
- Download from https://www.postgresql.org/download/windows/
- Install and create database using pgAdmin

### Step 2: Set Up Environment

```bash
# Copy environment template
cp .env.example .env

# Edit .env
DATABASE_URL=postgresql://localhost/consequence_ai
```

### Step 3: Install Dependencies

```bash
# Create virtual environment
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install packages
pip install -r requirements.txt
```

### Step 4: Run Migrations

```bash
# Create tables and migrate data
python scripts/migrate_to_db.py

# Verify
python scripts/migrate_to_db.py --dry-run
```

### Step 5: Start Development Server

```bash
# Start API
uvicorn src.api.main:app --reload --port 8000

# Test
curl http://localhost:8000/health
```

---

## Database Management

### View Data

```bash
# Connect to database
psql $DATABASE_URL

# or on Railway
railway run psql $DATABASE_URL
```

```sql
-- Check migration
SELECT COUNT(*) FROM entities;
SELECT COUNT(*) FROM causal_links;

-- Sample relationships
SELECT source, target, strength, confidence
FROM causal_links
WHERE data_source = 'sec_filing'
LIMIT 10;

-- Accuracy stats
SELECT * FROM accuracy_stats;
```

### Refresh Materialized Views

```sql
REFRESH MATERIALIZED VIEW CONCURRENTLY accuracy_stats;
```

### Backup Database

```bash
# Local
pg_dump consequence_ai > backup.sql

# Railway
railway run pg_dump $DATABASE_URL > backup.sql

# Restore
psql consequence_ai < backup.sql
```

---

## GitHub Actions Setup (Cron Jobs)

Create `.github/workflows/daily_update.yml`:

```yaml
name: Daily Data Update

on:
  schedule:
    - cron: '0 11 * * *'  # 6am ET = 11am UTC
  workflow_dispatch:  # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Update prices
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: python scripts/daily_update.py
```

**Add secret**: Repository → Settings → Secrets → New repository secret
- Name: `DATABASE_URL`
- Value: Your PostgreSQL connection string

---

## Monitoring & Logs

### Railway Logs

```bash
# View logs
railway logs

# Follow logs
railway logs --follow
```

### Health Checks

```bash
# API health
curl https://your-app.up.railway.app/health

# Database health
curl https://your-app.up.railway.app/db/health
```

### Metrics Dashboard

Railway provides:
- CPU usage
- Memory usage
- Request count
- Error rate

Access in Railway dashboard → Metrics tab.

---

## Troubleshooting

### Database Connection Issues

```python
# Test connection
from src.db.connection import init_db, get_db_session

init_db("postgresql://...")
with get_db_session() as session:
    from src.db.models import Entity
    count = session.query(Entity).count()
    print(f"Entities: {count}")
```

### Migration Failures

```bash
# Dry run first
python scripts/migrate_to_db.py --dry-run

# Check logs
tail -f railway.log  # or check Railway dashboard
```

### Out of Memory

Railway free tier: 512MB RAM

**Solutions**:
- Use `NullPool` (already configured for Railway)
- Reduce `DB_POOL_SIZE` to 3
- Upgrade to Railway hobby plan ($5/mo, 8GB RAM)

---

## Cost Estimation

### Railway (Recommended)

**Free Tier**:
- 512MB RAM
- $5 free credit/month
- **Cost**: $0/month for MVP
- Automatically sleeps after inactivity

**Hobby Plan** (when scaling):
- 8GB RAM
- $5/month
- No sleeping

### Supabase + Vercel

**Free Tier**:
- Supabase: 500MB database, 50,000 API requests
- Vercel: 100GB bandwidth, serverless functions
- **Cost**: $0/month for MVP

---

## Next Steps After Deployment

1. ✅ Verify API is accessible
2. ✅ Test prediction endpoint
3. ✅ Set up daily cron jobs
4. ⬜ Add monitoring (Sentry, LogRocket)
5. ⬜ Set up custom domain
6. ⬜ Configure SSL (auto on Railway/Vercel)
7. ⬜ Add rate limiting
8. ⬜ Set up analytics

---

## Production Checklist

- [ ] DATABASE_URL environment variable set
- [ ] Migrations run successfully
- [ ] Health check returns 200
- [ ] CORS configured for frontend
- [ ] GitHub Actions scheduled
- [ ] Backups configured
- [ ] Monitoring set up
- [ ] Error tracking enabled
- [ ] Rate limiting configured
- [ ] SSL certificate active

---

## Support & Resources

- **Railway Docs**: https://docs.railway.app
- **Supabase Docs**: https://supabase.com/docs
- **PostgreSQL Docs**: https://www.postgresql.org/docs/
- **FastAPI Deployment**: https://fastapi.tiangolo.com/deployment/

---

**Ready to deploy?** Start with Railway for simplest setup!
